# 2.1 网络地址和域名管理

[toc]

## 路由协议

### **基本概念**（什么是路由协议）

1. 路由协议是一种在internet上动态寻找恰当路径的机制
2. 目的是实现网络互联
3. 路由信息确定了两个通道
   1. 主叫主机到目标主机
   2. 目标主机到主叫主机（可以是第一条的逆通道，也可以是走别的路回去的）
4. 这两条通道互逆则为对称路由，否则为非对称路由
5. 非对称路由的优点是负载均衡，缺点是有多个防火墙时可能会引发安全问题

路由协议是一种在internet上动态寻找恰当路径的机制，这套机制通过一套算法可以计算出报文在各个主机之间的最优的转发路径。

路由协议是TCP/IP协议工作的基础。

**与TCP/IP协议族不同：**

TCP/IP协议族只关系报文在主机或者在应用层的是如何处理的，而不关系报文是如何从一个主机转发到另外一个主机的。

而报文如何从一个主机转发到另外一个主机则是路由协议的主要内容。

### 路由协议的安全问题

#### 1、宽松路由

利用IP中的“宽松路由（loose source route）”选项，这个可选项列出了一个或多个中间目的的地址，要求数据包在到达最终目的地址前需经过这几个中间地址。

这是一种最容易的办法。

采用这一选项，发起TCP连接的人能够指定一条到达目标主机的确切路由，并改写由正常的路由选择进程所选择的路由。 根据RFC 1122，目标主机必须使用逆通道作为返回路由。 这意味着攻击者可以假冒目标主机所信任的任意一台主机（又称之为“源路由欺骗”）。

**应对措施**

1、拒绝接受含有这一选项的数据包：

这是抵御源路由欺骗最简单的办法。

许多路由器提供这一功能。尽管人们有时确实会用到源路由（Source Routing）功能（例如，有时人们可能用它来调试某些网络故障，许多ISP也在骨干网络上使用这一功能），但是源路由很少用于正当的目的。

 如果在配置防火墙时使这一功能失效，你的防火墙就比较安全。上面提到的源路由应用不需要穿越管理边界。另外，某些版本的 rlogind和rshd也将拒绝含有源路由的连接。 使这一选项失效仅仅是下策，因为其他协议也可能有同样的缺陷。此外，即使一些应用能够丢掉含有源路由的数据包，源路由的误用仍然可以导致其他类型的攻击。攻击者可以从合法连接中发现序号，并实施**序号攻击**。我们在介绍TCP时就已经讨论了序号攻击。

#### 2、路由欺骗攻击

利用伪造的路由信息协议数据包，使目标主机相信攻击主机使一台可信主机

这是一种“玩弄”路由协议攻击手段。

攻击者很容易将伪造的路由信息协议（RIP，Routing Information Protocol）数据包注入网络中。

主机和路由器通常会相信这些数据包。如果攻击主机到达目标主机的距离比真正的源点主机更近，就容易改变数据流的方向。 许多RIP的实现方案甚至可以接收特定主机的路由，要检测它就更加困难.

#### 3、源路由攻击

获取TCP序列号，冒充可信节点进行攻击，关闭开放路由的功能并且拒绝来自于外部的报文，却声称自己是内部的主机报文

#### **应对措施**

1. 关闭主机和路由器上的源路由功能。

## RIP协议

### 什么是RIP协议

路由信息协议（RIP，Routing Information Protocol）是一种动态路由选择协议，根据跳数衡量相邻路由器的距离，相距较远的路由器就会被删除且其距离被设为无限大。

### RIP协议的安全问题

#### 1、RIP数据包注入，改变数据流方向

一旦最佳路由失效，则采用备份路由。有3分钟延迟才能启动。

不考虑链路的连接速度，而仅仅用hopcount来衡量路径的长短。

#### 2、接受特定主机的路由

## 路由协议的相关安全研究

### 1、OSPF协议

#### 什么是OSPF协议

即有限开放协议（Open Shortest Path First）。

1. 使路由选择基于链路状态而不是距离
2. 基于迪杰特斯拉算法（Dijkstra算法）

**优点：**

1. 验证机制相对完善：
   1. 支持三种机制对路由间交换的信息进行验证
2. 可靠的扩散机制
3. 分层路由

**缺点**

1. 空验证和简单口令验证
2. 加密验证方式存在漏洞
   1. 可通过特定重放引起路由震荡
3. 协议细节上存在漏洞：篡改LSA
   1. +1攻击
   2. 最大序列号攻击
   3. 最大年龄攻击

### 2、IS-IS协议

为无连接网络协议CLNP（Connection-Less Network Protocol）设计的一种动态路由协议，为了提供对IP 的路由支持，IETF 在RFC1195 中对IS-IS进行了扩充和修改，使它能够同时应用在TCP/IP协议和OSI环境中，称之为集成化IS-IS

有些ISP 在内部使用了OSI的IS-IS路由协议，以替代OSPF 协议。

这样做有一个好处，即==网络用户不能注入虚假的路由消息。 由于IS-IS并非承载于IP之上，所以它与用户没有连通性。==

 **注意：采用这一技术并不能抵御公司内部的不法人员发起的攻击。**

### 3、**边界网关协议（BGP, Border Gateway Protocol）**

1. l边界网关协议（BGP）是运行于 TCP 上的一种自治系统的路由协议。 
2. BGP 是唯一一个用来处理像因特网大小的网络的协议，也是唯一能够妥善处理好不相关路由域间的多路连接的协议。 
3. BGP 系统的主要功能是和其他的 BGP 系统交换网络可达信息。
4. BGP用于为Internet上的核心路由器生成路由表。各种自主系统通过广播交换网络位置信息。

BGP用于为Internet上的核心路由器生成路由表。各种自主系统（AS，Autonomous System）通过广播交换网络位置信息。 这些广播信息以一种稳定的数据流发送，平均每几秒钟就发送一次。一次广播只需要花20分钟或更多的一点时间就可传遍整个Internet.
所分配的路由信息中包含许多内容，如它可能含有对某个目标主机或数据包类型进行特别处理的信息。 如果路由信息中含有其他因子，如路由聚合和转发延迟，就很可能会引起混乱。

显然，这些路由广播信息是非常重要的。任何错误的、恶意的广播都会造成Internet混乱。黑客可以采用这种破坏性的路由广播实施各种攻击。现在已经出现关于黑客对BGP发起攻击的报道。

**攻击手段**

黑客使用路由器让经由GRE隧道的数据流改变方向，并窃听、劫持或抑制正常的会话。 还有一些人会向自己所处的网络广播一个路由，并攻击某个目标，然后在法律取证调査之前删除这一路由。

**防护措施**

1、采用MD5的BGP认证机制（没有广泛应用）

2、S-BGP方案

### 4、BOOTP协议

**BOOTP（Bootstrap Protocol，引导程序协议）**

是一种引导协议，基于IP/UDP协议，也称自举协议，是DHCP协议的前身。BOOTP用于无盘工作站的局域网中，可以让无盘工作站从一个中心上获得IP地址。通过BOOTP协议可以为中的分配，这样就不需要管理员去为每个用户去设置静态IP地址。

### 5、DHCP协议

动态主机配置协议（DHCP，Dynamic Host Configuration Protocol）用来==分配IP地址==，并==提供启动计算机（或唤醒一个新网络）的其他信息==。 处于启动状态的客户机发送UDP广播数据包，服务器会对查询做出响应。 这些查询信息可以使用中继程序向前传递到其他网络。服务器会给主机分配一个固定的IP地址.

DHCP是BOOTP的扩展，基于客户/服务器模式。 它提供了一种动态指定IP地址和配置参数的机制，这==主要用于大型网络环境和配置==比较困难的情况。 DHCP 的配置参数使得网络上的计算机通信变得方便且容易实现。 

DHCP可以缓解IP地址不足的问题：

DHCP使用户可以租用IP地址，对于拥有成百上千台计算机的大型网络来说，每台计算机拥有一个IP地址有时是不必要的。IP地址采用“租约”的方式，租期从1分钟到100年不定。 当租期已到时，服务器可以把这个IP地址分配给其他机器使用。当然，客户也可以请求使用自己喜欢的网络地址及相应的配置参数。

主要功能：

1. 分配IP地址，并提供启动计算机的其他信息
2. 解决大型网络环境配置困难的问题
3. 缓解IP地址不足的问题
4. 实现移动性接入

#### DHCP存在的安全问题

1. DHCP可用作法庭上的重要证据
2. 无法对DHCP进行远程攻击，但无法阻止本地攻击
3. 查询响应易受到中间人的DOS攻击
4. 压制合法DHCP服务器，对查询响应进行虚假响应

**DHCP日志可以用做法庭上的重要证据。**特别是在进行IP地址动态分配的时候，我们需要知道在某个给定的时刻，哪个硬件设备使用了哪个IP地址。日志中所记录的以太网地址是非常有用的。当计算机犯罪事件发生时，网警将会设法取得ISP的DHCP日志（包括RADIUS或其他认证日志），并对日志进行分析。

此协议只能在本地网络上使用，攻击者无法发起远程攻击。

由于没有对查询信息进行认证，易受**中间人攻击**和**DOS攻击**

#### BOOTP和DHCP的区别

1. BOOTP用于无磁盘主机连接的网络上面的，网络主机使用BOOT ROM而不是磁盘启动并连接上网络，
2. BOOTP可自动设定TCP/IP环境
3. BOOTP缺点在于设定TCP/IP环境前需先获得客户端的硬件地址，且硬件地址与IP的对应关系是静态的
4. BOOTP只在启动的时候发送单条消息
5. 而DHCP启动后还对IP地址和其他消息进行维护

## 域名系统DNS

==一般使用的是53号端口==

域名：www.baidu.com

IP地址：192.168.1.1

**域名系统（DNS，Domain Name System）**是一个分布式数据库系统，用来实现域名到IP地址或IP地址到域名的映射。在Internet上，域名与IP地址之间是一一对应的。

域名虽然便于人们记忆，但机器之间只能互相识别IP地址，它们之间的转换工作称为**域名解析**，域名解析的工作需要由专门的域名解析服务器来自动完成。 域名解析服务器也称做DNS服务器，DNS服务使用的是53号端口。

### DNS域名转换的过程是怎么样的

1. 用户向DNS 客户端发送DNS请求，客户端先查看本地缓存，如果缓存中有该域名，则直接返回给用户；客户端若没有域名的相关缓存，则向本地域名服务器提出解析请求。
2. 本地域名服务器在收到请求后，先查看缓存，若缓存中有相关记录，则应答客户端的请求；否则，本地域名服务器直接向根域名服务器提出请求。
3. 根域名服务器接到请求后，将包含有所需解释的域名的顶级域名服务器返回给本地域名服务器。
4. 本地域名服务器根据根域名服务器的返回结果，向顶级域名服务器发送请求。
5. 顶级域名服务器接到请求后，将包含所查询的域名的域名服务器返回给本地域名服务器。
6. 本地域名服务器根据返回结果连接包含域名的域名服务器，得到查询结果，然后将查询结果缓存，并向客户端应答。
7. 客户端接到应答后，将查询结果缓存，然后向用户应答。

### DNS的安全问题

#### 1、DNS欺骗

DNS的查询请求是基于UDP的，DNS客户端会接受首先到达的DNS应答包，而将后到达的DNS应答包当作是冗余包简单丢弃掉。客户端对DNS应答包的验证仅通过随机发送的查询ID和UDP端口号，除此之外没有任何的验证。这就给DNS欺骗提供了机会。 

**DNS缓存攻击——生日悖论数学模型**(生日攻击)

1. 攻击者向DNS服务器发送解析不了的DNS，服务器会向上层服务器发送相同数量的请求
2. 而后攻击者快速发送一定数量的伪造DNS应答包，其中的ID和端口号是随机的，当伪造的随机ID和端口号与正确的相“碰撞”时，服务器会舍弃舍弃后来的正确的DNS解析项而缓存错误的DNS解析项。缓存攻击成功，所有的DNS请求都会导向攻击者伪造的IP地址。
3. 可以证明一次攻击所需发送的伪造包的数量不多，攻击十分易于发动也易于成功。

#### 2、分布式拒绝服务攻击DDOS

##### 2.1 利用僵尸网络

攻击者通过控制的僵尸网络（成百上千的被控主机群）向目标服务器发送DNS查询请求，从而导致目标DNS服务器过载以及网络线路堵塞。

实例：“暴风影音DNS攻击”

##### 2.2 利用DNS软件漏洞

利用DNS软件的漏洞发送特定的DNS请求导致用户的请求无法得到DNS服务器的任何应答，从而形成DoS攻击。

##### 2.3 缓存区溢出攻击

利用DNS软件对输入的请求字符不做严格的检查的安全漏洞，攻击者构造特殊的数据包攻击DNS服务器，造成DNS缓存区溢出，溢出成功后通过执行特殊代码获得高级权限，从而得到DNS服务器的控制权。

#### 3、管理缺陷

目前的DNS管理、配置以及安全机制比较低级，主要依赖管理者的实际经验。

#### 4、DNS防范攻击的措施

1. 防范ARP攻击
2. 采用UDP的随机端口
3. 建立静态IP映射
4. 运行最新版本的BIND
5. 限制查询
6. 利用防火墙来保护
7. 利用交叉检验
8. 利用DNSSEC机制

##### **DNSsec工作原理：**

为提高DNS访问数据包的安全性，DNSSEC在兼容现有协议的基础上引入加密和认证体系，在每个区域都有一对区域级的密钥对，密钥对中的公钥对域名记录信息进行数字签名，从而使支持DNSSEC的接收者可以校验应答信息的可靠性。 

DNSSEC引入两个全新的资源记录类型：KEY和SIG，允许客户端和域名服务器对任何DNS数据来源进行密钥验证。DNSSEC主要依靠公钥技术对于包含在DNS中的信息创建密钥签名，密钥签名通过计算出一个密钥Hash数来提供DNS中数据的完整性，并将该Hash数封装进行保护。私／公钥对中的私钥用来封装Hash数，然后可以用公钥把Hash数翻译出来。如果这个翻译出的Hash值匹配接收者计算出来的Hash数，那么表明数据是完整的、没有被篡改的。 

##### DNSsec的优缺点：

优点：可以对DNS记录进行数字签名，消除DNS欺骗

缺点：对根域名的签名却并不对数据进行加密，只是验证访问站点地址是否有效。

#### 为什么要对根域名进行签名？

如果不这么做，攻击者将大大缩短了DNS查找过程中的任意步骤所需的时间，从而可以更快地取得对会话的控制并实施某种恶意的操作。

## 网络地址转换（NAT）

### 基本概念

迄今，网络的IP地址面临着耗尽的危险。甚至有人声称目前的IP地址已经用完了。在这种情况下，网络地址转换盒（NAT boxes）就应运而生。

从概念上讲，网络地址转换（NAT）非常简单：

它们监听使用了所谓专用地址空间132的内部接口，并对外出的数据包重写其源地址和端口号。 外出数据包的源地址使用了 ISP 为外部接口分配的Internet 静态IP地址。 对于返回的数据包，它们执行相反的操作。 但在现实中，网络地址转换却并非如此简单。

### 什么是NAT？

网络地址转换(NAT,Network Address Translation)属接入广域网(WAN)技术。

是一种将私有（保留）地址转化为合法IP地址的转换技术，它被广泛应用于各种类型Internet接入方式和各种类型的网络中。原因很简单，NAT不仅==完美地解决了lP地址不足的问题==，而且==还能够有效地避免来自网络外部的攻击，隐藏并保护网络内部的计算机==。 

### NAT的工作原理

1. 内外网IP地址转换
2. 内外网络隔离提供一定的安全保障
3. IP地址映射模式
   1. 一对一
      1. 静态模式
      2. 动态模式
   2. 多对一模式
      1. 复用NAT

### NAT的安全问题

从安全的角度看，NAT最严重的问题是它不能与加密协调工作。很显然，NAT不能对加密的应用数据流进行检查。其次，某些形式的IPsec与NAT并不兼容。IPsec 能对传输层协议头部进行加密，而此协议的头部包含一个校验和，该校验和中包含NAT盒要重写的IP地址。

**NAT时防火墙的一个基本功能，但并不是真正的防火墙。**

#### 1、单点攻击

1. SYN Flood
2. Ping Flood

#### 2、与IPsec的冲突问题

#### 3、不能加密协调