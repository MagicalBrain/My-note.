# 2.2 IP协议、ARP协议、ICMP协议

[toc]

# IP协议

## 基本概念

网际协议（IP，Internet Protocol）是TCP/IP的心脏，也是网络层中最重要的协议。
IP数据包是一组数据，这些数据构成了 TCP/IP协议族的基础。 每个数据包含有源地址、目的地址及其他选项，如比特位、头校验位和数据净荷等。典型的IP数据包有几百个字节长。

成千上万的数据包通过以太网、串行线、SONET环网、分组无线电连接、帧中继连接、异步转移模式（ATM，Asynchronous Transfer Mode）链路等进行传输。

IP层接收由更低层（网络接口层例如以太网设备驱动程序）发来的数据包，并把该数据包发送到更高层－TCP或UDP层；相反，IP层也把从TCP或UDP层接收来的数据包传送到更低层。IP数据包是不可靠的，因为IP并没有做任何事情来确认数据包是按顺序发送的或没有被破坏。 IP数据包中含有发送它的主机的地址（源地址）和接收它的主机的地址（目标地址）.

高层的TCP和UDP 服务在接收数据包时，通常假设包中的源地址是有效的。 也可以这样说，IP地址形成了许多服务的认证基础，这些服务相信数据包是从一个有效的主机发送来的。IP 确认包含一个选项，叫做“IP source routing”，可以用来指定一条源地址和目的地址之间的直接路径。对于一些TCP和UDP的服务来说，使用了该选项的IP包好像是从路径上的最后一个系统传递过来的，而不是来自于它的真实地点。 这个选项是为了测试而存在的，当然，黑客也可以用它欺骗系统来进行平常是被禁止的连接。此时，许多依靠IP源地址认证的服务将产生问题并且会被非法入侵。

### IP数据包首部的组成部分是？

1. 版本
2. 首部长度
3. 区分服务
4. 总长度
5. 标识
6. 标志
7. 片位移
8. 生存时间
9. 协议
10. 首部检验和
11. 源地址
12. 目的地址
13. 可选字段

[参考链接](https://zhuanlan.zhihu.com/p/74106328)

### 什么是数据包，什么是数据报，二者之间的关系？

一般来说，IP数据包在TCP中是无需切片的，但是在UDP中如果包的大小超过了应用层的限制大小就需要切片。数据包的切片即数据报。

但是IP地址是没有切片的，因为如果IP地址也要切片的话，有一片丢失，所有的切片都要重新传输（因为IP地址不完整就无法发送出去）。故每一个数据报都有个IP首部，这个是首部是定长的，里面存有IP地址。

![](https://pic1.zhimg.com/v2-626806b6c8959a1541631685be1cc588_r.jpg)

[参考链接](https://zhuanlan.zhihu.com/p/62104550)

## 安全问题

**IP攻击**

事实上，IP不能保证数据一定是从数据包中的源地址发送的。 任意一台主机都能发送具有任意源地址的数据包。 尽管许多操作系统能够控制源地址的生成， 以确保数据离开主机时能够被赋予正确值，尽管某些ISP 也能限制不符合要求的数据包流出网站，但我们一定不要靠检验源地址来判断数据包的好坏。尽管有些协议确实就是靠检验源地址来判别数据包的，但是我们必须记住认证不能依赖于源地址域的检验。 通常攻击者会发送含有伪造返回地址（源地址）的数据包以欺骗接收者，这种攻击叫做IP 欺骗攻击。一般来说，认证需要采用高层协议中的安全机制来实现.

### 总结

1. 不能保证有序
2. 不能保证完整性
3. 非面向连接，不可靠连接业务：不能保证是否传送出去且仅传送一次
4. 不能保证可靠的链路：数据报丢弃，TCP拥堵
5. 数据包的分片和重组：在中间结点不能对数据包进行重组，数据报的重叠问题
6. 无分类域间路由

# 地址解析协议（ARP）

在局域网中，网络中实际传输的是“帧”，帧里面有目标主机的MAC地址。在以太网中，一个主机和另一个主机进行直接通信，必须要知道目标主机的 MAC 地址（也称为以太地址或物理地址）。但这个目标MAC地址是如何获得的呢？它就是通过地址解析协议（ARP，Address Resolution Protocol）获得的。

所谓“地址解析”，就是主机在发送帧前将目标IP地址转换成目标MAC地址的过程。ARP的基本功能就是根据目标设备的IP地址查询目标设备的MAC地址，以保证通信的顺利进行.

ARP主要负责将局域网中的32bit IP地址转换为对应的48 bit物理地址，即网卡的MAC地址.

例如，IP地址为192.168.0.1，网卡MAC地址为00-03-0F-FD-1D-2B.IP数据包通常经过以太网发送。以太网络设备不能理解32bit的IPv4地址，它们发送的是具有48 bit以太地址的以太数据包。因此，IP驱动程序必须能将IP 目标地址转换成MAC地址。 在这两类地址之间存在静态或算法上的映射，通常需要进行地址表查询。 地址解析协议 ARP9用来决定这些映射。ARP协议也可用于其他类型的链路，前提是这些链路一定要采用某种链路层的广播机制。
发送者通过 ARP 发送包含目标IP地址的以太网广播数据包，目标主机或其他系统将对此做出响应，发回一个含有IP地址和以太地址对的数据包。发送者会将该数据包放在缓冲区保存，这样可以避免在后续通信时产生不必要的 ARP数据流。
如果不可信的节点对本地网络具有写访问权限，这将非常危险。一台不可信的计算机会发出假冒的ARP 查询或应答信息，然后将所有流向它的数据流转移。这样，它就可以伪装成某台机器或修改数据流向，这叫做ARP欺骗。许多HOTS（Hacker Off-The-Shelf）软件包都能够实现这种攻击。
ARP地址解析机制通常是自动完成的。在具有高安全性的网络上，ARP是通过硬件实现静态映射的，并且禁止使用自动协议以防止干扰。 如果要禁止两台主机通信，那么我们只需确保它们相互不能进行 ARP翻译即可。然而，在网络中要确保它们永远不能获得映射表是非常困难的·一件事。

## 什么是ARP

即地址解析协议，用于在发送帧之前将IP地址转换成MAC地址。

这个过程一般是自动完成的，进制使用自动协议防止干扰。

使用了老化机制，如果有一行长时间没人使用将会被删除，以减少查询时间。

## 安全性缺陷

### 1、ARP欺骗

通过伪造IP地址和MAC地址就能实施ARP欺骗，能够在网络中产生大量的ARP通信量是网络阻塞或者实现"man in the middle"，从而进行ARP重定向和嗅探攻击。

### 2、ARP高速缓存

每一个主机都有一个ARP高速缓存存储最近IP地址到MAC地址之间的映射记录

# ICMP协议

## 什么是ICMP协议

Internet控制消息协议（ICMP，Internet Control Message Protocol），是一个介于传输层和网络层的协议，主要功能是传输网络诊断信息。

主要传送两种信息：

1. 错误信息：诊断网络故障
2. 咨询信息：查询路由

ICMP的诊断不能帮助IP协议成为可靠的协议。

## ICMP的安全性

### 1、重定向

黑客通过修改达到正确目的地的路由，就可能攻破计算机

### 2、Path of MTU

主机常采用Path of MTU机制，发送不可达的且设置了“不可分段比特位”的巨大数据包来测试多大的数据包不用分段发送。

### 3、Ping of Death

当主机发送大数据包的时候将会遇到“难以诊断的死点”而结束传递。