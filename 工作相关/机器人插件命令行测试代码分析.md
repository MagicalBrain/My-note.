# 机器人插件命令行测试代码分析

## source.cpp

```cpp
#include <common/HYPluginFactory.hpp>
#include <robot/HYRobotPlugin.hpp>

#include <io/FileHelper.h>
#include <common/LoggerHelper.hpp>

#include <iostream>

using namespace hy;

int main(int argc, const char** argv)
{
	//输入插件的路径
	std::string path;
	std::cout << "Please input plugin path:";
	std::cin >> path;


	HY_LOG_SEV(info) << "looking at " << path;
	std::vector<std::string> files;
	FileHelper::EnumerateFiles(path, files, "^.*?\.dll$");

	HYPluginFactory* factory = PluginFactoryInstance();
	std::string id;

	for (auto file : files)
	{
		factory->load(file, id);
	}
	
	files.clear();
	factory->all(files, PLUGIN_TYPE_ROBOT);
	std::cout << "Plugin loaded:" << std::endl;
	for (auto file : files)
		std::cout << "\t" << file << std::endl;

	//输入机器人插件的id
	std::cout << "Select plugin: ";
	std::cin >> id;
	std::cin.ignore();	//忽略回车？

	//根据输入的id寻找对应的插件
	HYRobotPlugin::Ptr robot_plugin_ = factory->find<HYRobotPlugin>(id);
 	if (robot_plugin_ == nullptr)
	{
		HY_LOG_SEV(error) << boost::format("no plugin id match %1%") % id;
		return PLUGIN_ERROR_FAIL;
	}
	else
		HY_LOG_SEV(info) << boost::format("get plugin %1% sucess") % id;

	if (PLUGIN_ERROR_SUCESS != robot_plugin_->initialize())
	{
		HY_LOG_SEV(error) << boost::format("plugin %1% initialize fail") % id;
		return PLUGIN_ERROR_FAIL;
	}
	
	std::vector<double> pose;
	std::vector<double> jointsPose;
	char key;
	double value;
	std::string host;
	int port;
	NavigationParam param;
	do
	{
		std::cout << "Options:" << std::endl;
		std::cout << "q = quit, s = set speed, a = set address and port c = connect robot, g = go, n = navigation" << std::endl; 
		std::cout << "x|y|z|u|v|w = update pose by x|y|z|u|v|w" << std::endl;
		std::cout << boost::format("%1%Please input your options: ") % pose;
				
		std::cin >> key;
		switch (key)
		{
		case 'a':
			std::cin >> host;
			std::cin >> port;
			robot_plugin_->address(host, port);
			break;
		case 's':
			std::cin >> value;
			robot_plugin_->speed(value);
			break;
		case 'r':
			std::cin >> host;
			robot_plugin_->run(host);
			break;
		case 'c':
			if (!robot_plugin_->connected())
			{
				if (PLUGIN_ERROR_SUCESS != robot_plugin_->connect())
				{
					HY_LOG_SEV(error) << boost::format("connect robot %1% fail") % id;
					return PLUGIN_ERROR_FAIL;
				}
			}

			if (PLUGIN_ERROR_SUCESS == robot_plugin_->pose(pose))
				HY_LOG_SEV(info) << "robot pose " << pose;
			else
			{
				HY_LOG_SEV(error) << "get robot pose fail";
			}
			if (PLUGIN_ERROR_SUCESS == robot_plugin_->pose(jointsPose, ROBOT_POSE_JOINT))
				HY_LOG_SEV(info) << "robot joint pose " << jointsPose;
			else
			{
				HY_LOG_SEV(error) << "get robot joint pose fail";
			}
			break;
		case 'x':
			std::cin >> value;
			pose[0] += value;
			break;
		case 'y':
			std::cin >> value;
			pose[1] += value;
			break;
		case 'z':
			std::cin >> value;
			pose[2] += value;
			break;
		case 'u':
			std::cin >> value;
			pose[3] += value;
			break;
		case 'v':
			std::cin >> value;
			pose[4] += value;
			break;
		case 'w':
			std::cin >> value;
			pose[5] += value;
			break;
		case 'g':
			if (PLUGIN_ERROR_SUCESS != robot_plugin_->move(pose))
				HY_LOG_SEV(error) << boost::format("move to %1% fail") % pose;			
			break;
		case 'n':		
			param.Destination = pose;
			param.Transition = pose;
			param.Transition[2] += 30;
			param.Position = -1;
			if (PLUGIN_ERROR_SUCESS != robot_plugin_->navigation(param))
				HY_LOG_SEV(error) << boost::format("navigation to %1% fail") % pose;
			break;
		case 'q':
			robot_plugin_->disconnect();
			robot_plugin_->release();
			return PLUGIN_ERROR_SUCESS;
			break;
		default:
			break;
		}
		std::cin.ignore();
	} while (true);

	return PLUGIN_ERROR_SUCESS;
}
```