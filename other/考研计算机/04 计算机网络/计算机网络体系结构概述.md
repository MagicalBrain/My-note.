# 计算机网络体系结构概述

## 基本概念

### 1、什么是网络协议？

在计算机网络要做到有条不紊地交换数据，就必须遵守一些事先约定好的规则，比如交换数据的格式、是否需要发送一个应答信息。这些规则被称为网络协议。

### 2、为什么要对网络进行分层？（网络分层的优点）

- ==简化问题难度和复杂度==。由于各层之间独立，我们可以分割大问题为小问题。
- ==灵活性好==。当其中一层的技术变化时，只要层间接口关系保持不变，其他层不受影响。
- ==易于实现和维护==。
- ==促进标准化工作==。分开后，每层功能可以相对简单地被描述。

### 3、网络分层有缺点吗？缺点是？

功能可能出现在多个层里，产生了额外开销。

## 常见的网络分层协议

### 1、OSI七层协议

为了使不同体系结构的计算机网络都能互联，国际标准化组织 ISO 于1977年提出了一个试图使各种计算机在世界范围内互联成网的标准框架，即著名的开放系统互联基本参考模型 OSI/RM，简称为OSI。

OSI 的七层协议体系结构的概念清楚，理论也较完整，但它既复杂又不实用。

​	其实是在OSI标准推出前，TCP已经占据了市场的大部分份额，导致OSI没有市场了。

#### OSI七层协议模型

主要包括是：

1. 应用层（Application）、
2. 表示层（Presentation）、
3. 会话层（Session）、
4. 运输层（Transport）、
5. 网络层（Network）、
6. 数据链路层（Data Link）、
7. 物理层（Physical）。

### 2、TCP五层协议

TCP五层协议的体系结构主要包括：

1. 应用层、
2. 运输层、
3. 网络层，
4. 数据链路层
5. 物理层。

==注意：五层协议只是为了介绍网络原理而设计的，实际应用还是 TCP/IP 四层体系结构。==

### 3、TCP四层协议

主要包括：

1. 应用层、
2. 运输层、
3. 网际层
4. 网络接口层。

## TCP/IP协议族

### 应用层

应用层( application-layer ）的任务是通过应用进程间的交互来完成特定网络应用。应用层协议定义的是应用进程（进程：主机中正在运行的程序）间的通信和交互的规则。

### 传输层（运输层）

运输层(transport layer)的主要任务就是负责向两台主机进程之间的通信提供通用的数据传输服务。应用进程利用该服务传送应用层报文。

主要有：

1. TCP协议（传输控制协议）
2. UDP协议（用户数据协议）

#### 传输层协议与应用层协议的联系

每一个应用层的协议都至少会使用到两个传输协议中的一个，具体如下：

**运行在TCP协议上的协议：**

- HTTP（Hypertext Transfer Protocol，超文本传输协议），主要用于普通浏览。
- HTTPS（HTTP over SSL，安全超文本传输协议）,HTTP协议的安全版本。
- FTP（File Transfer Protocol，文件传输协议），用于文件传输。
- POP3（Post Office Protocol, version 3，邮局协议），收邮件用。
- SMTP（Simple Mail Transfer Protocol，简单邮件传输协议），用来发送电子邮件。
- TELNET（Teletype over the Network，网络电传），通过一个终端（terminal）登陆到网络。
- SSH（Secure Shell，用于替代安全性差的TELNET），用于加密安全登陆用。

**运行在UDP协议上的协议：**

- BOOTP（Boot Protocol，启动协议），应用于无盘设备。
- NTP（Network Time Protocol，网络时间协议），用于网络同步。
- DHCP（Dynamic Host Configuration Protocol，动态主机配置协议），动态配置IP地址。

**同时运行在TCP和UDP协议上：**

- DNS（Domain Name Service，域名服务），用于完成地址查找，邮件转发等工作。

### 网络层

网络层的任务就是选择合适的网间路由和交换结点，确保计算机通信的数据及时传送。在发送数据时，网络层把运输层产生的报文段或用户数据报封装成分组和包进行传送。在 TCP/IP 体系结构中，由于网络层使用 IP 协议，因此分组也叫 IP 数据报 ，简称数据报。

互联网是由大量的异构（heterogeneous）网络通过路由器（router）相互连接起来的。互联网使用的网络层协议是无连接的网际协议（Intert Prococol）和许多路由选择协议，因此互联网的网络层也叫做网际层或 IP 层。

### 数据链路层

数据链路层(data link layer)通常简称为链路层。两台主机之间的数据传输，总是在一段一段的链路上传送的，这就需要使用专门的链路层的协议。

在两个相邻节点之间传送数据时，数据链路层将网络层交下来的 IP 数据报组装成帧，在两个相邻节点间的链路上传送帧。每一帧包括数据和必要的控制信息（如同步信息，地址信息，差错控制等）。

在接收数据时，控制信息使接收端能够知道一个帧从哪个比特开始和到哪个比特结束。

### 物理层

在物理层上所传送的数据单位是比特。 物理层(physical layer)的作用是实现相邻计算机节点之间比特流的透明传送，尽可能屏蔽掉具体传输介质和物理设备的差异。使其上面的数据链路层不必考虑网络的具体传输介质是什么。“透明传送比特流”表示经实际电路传送后的比特流没有发生变化，对传送的比特流来说，这个电路好像是看不见的。

## TCP的连接原理

### 三次握手（建立连接）

目的确认双方收发数据的能力。即在这个过程中要互相确认、互相告知双方的数据收发能力。

第一次握手

A发送给B，B如果收到了，B就知道了A的发送能力和B自己的接收能力是ok的，但此时A啥也不知道，B需通过第二次握手告知A

第二次握手

B发送数据给A，A如果收到了，A收到了来自B：“A的发送能力和B的接收能力是可以的”这个反馈，而且收到本身也证明了A自己的接收能力和B的发送能力是可以的。验证数据收发能力的过程到这里结束了，但是B还没有收到反馈，B还不知道自己发送能力和A的接受能力是不是正常的，故还需要A发送反馈给B，这就是第三次握手。

第三次握手

A发送反馈给B，告知B自己的接受能力和B的发送能力是可以的。

#### 我自己举的一个有趣的例子：

假设A与B在某社交软件上开麦尬聊：

A、B都是正常人，但由于A不知道B是不是聋哑人，B也不知道A是不是聋哑人，就有了如下对话：

```sequence
A -> B : 	（第一次握手）我有个问题要讨论，你听得见吗？ 
B -> A : （第二次握手）听得到，我又不是聋子
A -> B : （第三次握手）看来没聋没哑那我们开始讨论吧
```



### 四次挥手（关闭连接）

有的也称之为四次握手

- 第一次挥手：当客户端的数据都传输完成后，客户端向服务端发出连接释放报文(当然数据没发完时也可以发送连接释放报文并停止发送数据)，释放连接报文包含FIN标志位(FIN=1)、序列号seq=1101(100+1+1000，其中的1是建立连接时占的一个序列号)。需要注意的是客户端发出FIN报文段后只是不能发数据了，但是还可以正常收数据；另外FIN报文段即使不携带数据也要占据一个序列号。
- 第二次挥手：服务端收到客户端发的FIN报文后给客户端回复确认报文，确认报文包含ACK标志位(ACK=1)、确认号ack=1102(客户端FIN报文序列号1101+1)、序列号seq=2300(300+2000)。此时服务端处于关闭等待状态，而不是立马给客户端发FIN报文，这个状态还要持续一段时间，因为服务端可能还有数据没发完。
- 第三次挥手：服务端将最后数据(比如50个字节)发送完毕后就向客户端发出连接释放报文，报文包含FIN和ACK标志位(FIN=1,ACK=1)、确认号和第二次挥手一样ack=1102、序列号seq=2350(2300+50)。
- 第四次挥手：客户端收到服务端发的FIN报文后，向服务端发出确认报文，确认报文包含ACK标志位(ACK=1)、确认号ack=2351、序列号seq=1102。注意客户端发出确认报文后不是立马释放TCP连接，而是要经过2MSL(最长报文段寿命的2倍时长)后才释放TCP连接。而服务端一旦收到客户端发出的确认报文就会立马释放TCP连接，所以服务端结束TCP连接的时间要比客户端早一些。

#### 我自己想的一个有趣的例子：

假设我和女朋友（不存的，雾）晚上睡前开麦聊天，我要准备睡觉了不想聊了，但不知道女朋友还有没有话说，故有如下对话：

```sequence
我 -> 女朋友 : （第一次挥手）我不聊了，明早要早起搬砖，得睡了
女朋友 -> 我 : （第二次挥手）我还有话说，你听着吧
女朋友 -> 我 : （第三次握手）我说完了，我也准备睡了
我 -> 女朋友 : （第四次握手）知道啦，你睡吧
```



## 参考资料

[知乎大佬的文章](https://zhuanlan.zhihu.com/p/141396896)